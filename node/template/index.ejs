<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>西祠前端自动化构建平台</title>
	<link rel="stylesheet" href="<%= STATIC_SERVER %>/basecss/src/normalize.css">
	<link rel="stylesheet" href="<%= STATIC_SERVER %>/basecss/src/base.css">
	<style>
	body{font: normal normal 12px/20px 'arial';padding: 50px;}
	.console{
		border: 1px solid #bbb;
		color: #000;
		margin: 20px 0;
		padding: 10px;
		overflow-x: hidden;
		overflow-y: auto;
	}
	.console:before,
	.console:after{
		content: "";
		overflow: hidden;
	}
	.main_console{
		display: block;
		width: 400px;
		height: 200px;
	}
	.history_console{
		height: 200px;
		width: 300px;
		margin-left: 10px;
		word-wrap: break-word;
	}
	time{
		float: right;
		color: #ccc;
	}
	form .tip_info{
		display: inline-block;
		color: #bbb;
		margin-left: 10px;
	}
	form label{
		width: 50px;
		display: inline-block;
	}
	form input.mini{
		width: 40px;
	}
	</style>

	<script src="<%= STATIC_SERVER %>/fileuploader/src/main.js"></script>
	<script src="<%= STATIC_SERVER %>/ajax/src/main.js"></script>
	<script src="<%= STATIC_SERVER %>/utils/date/src/main.js"></script>

	<script src="<%= SOCKETIO_SERVER %>/socket.io/socket.io.js"></script>
	<script>
	SOCKETIO_SERVER = '<%= SOCKETIO_SERVER %>';
	</script>
</head>
<body>
	

	<h1>西祠前端自动化构建平台</h1>
	<p>服务器时间: <%=time %></p>
	<br>
	<form id="J_form" action="/upload" method="post" enctype="multipart/form-data">
		<input id="J_file" type="file" name="file"/>
		<input id="J_encoding" class="mini" placeholder="编码" id="Encoding" type="text" name="encoding" value=""/><span class="tip_info">默认编码：UTF8</span>
	</form>
	<br>
	<!-- <button onclick="form.submit();">同步提交</button> -->
	<button onclick="uploader.upload();">异步提交</button>
	
	<div class="clearfix">
		<div id="J_console" class="main_console console pull-left" cols="30" rows="10"></div>
		<div class="pull-left history_console console">
			<h4>历史记录</h4>
			<ol id="J_history">
				<!-- <li><a href="#">xici.ui.common.js</a><time>2014-1-3 12:00:00</time></li> -->
			</ol>
		</div>
	</div><!-- clearfix -->
	

	<script>
	var historyWrapper = document.getElementById('J_history');
	function ajaxHistory(){
		ajax({
			url : '/history',
			success : function(resp){
				if(resp.r){
					var len = resp.b.length;
					var back = ''
					for(var i = 0; i<len ; i++){
						back += '<li><a href="'+resp.b[i].url+'" target="_blank">'+resp.b[i].fileName+'</a> <time>'+date.printTime(resp.b[i].createdAt)+'</time></li>';
					}
					historyWrapper.innerHTML = back;
				}
			}
		});
	}
	ajaxHistory();

	var form = document.getElementById('J_form');
	var inputEncoding = document.getElementById('J_encoding');
	var uploader = new FileUpload({
		url : '/upload',
		fileTypes : 'js|zip',
		onCompleted : function(resp){
			console.info(resp);
			ajaxHistory();
		},
		onFileSelected : function(key, file){
			// console.info(key, file);
		},
		beforeUpload : function(o){
			this.addField('encoding', inputEncoding.value);
		}
	});

	var consoleArea = document.getElementById('J_console');
	function showMsg(msg){
		var origin = consoleArea.innerHTML;
		if(!origin){
			consoleArea.innerHTML = msg;
		}else{
			consoleArea.innerHTML = origin + '<br />' + msg;
		}
	}

	document.getElementById('J_file').onchange = function(e){
		if(e.target.files.length){
			var file = e.target.files[0];
			// console.info(file);
			uploader.addFile('file', file, this);
			// uploader.upload();
		}
	}

	var socket = io.connect(SOCKETIO_SERVER);
	socket.on('message', function(data){
		showMsg(data.msg);
	});	
	</script>

</body>
</html>	